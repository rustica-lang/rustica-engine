From 2558bca13e367875163361dc0a17c6af1210d8df Mon Sep 17 00:00:00 2001
From: Xenia Lu <xenia.lyy@gmail.com>
Date: Fri, 14 Jun 2024 13:38:54 +0800
Subject: [PATCH 1/2] Add aot_emit_aot_file.h

---
 core/iwasm/compilation/aot_compiler.h      |  8 --
 core/iwasm/compilation/aot_emit_aot_file.c | 61 +--------------
 core/iwasm/compilation/aot_emit_aot_file.h | 86 ++++++++++++++++++++++
 3 files changed, 87 insertions(+), 68 deletions(-)
 create mode 100644 core/iwasm/compilation/aot_emit_aot_file.h

diff --git a/core/iwasm/compilation/aot_compiler.h b/core/iwasm/compilation/aot_compiler.h
index 06dc7721..4172b46f 100644
--- a/core/iwasm/compilation/aot_compiler.h
+++ b/core/iwasm/compilation/aot_compiler.h
@@ -782,14 +782,6 @@ aot_compile_wasm(AOTCompContext *comp_ctx);
 bool
 aot_emit_llvm_file(AOTCompContext *comp_ctx, const char *file_name);
 
-bool
-aot_emit_aot_file(AOTCompContext *comp_ctx, AOTCompData *comp_data,
-                  const char *file_name);
-
-uint8 *
-aot_emit_aot_file_buf(AOTCompContext *comp_ctx, AOTCompData *comp_data,
-                      uint32 *p_aot_file_size);
-
 bool
 aot_emit_object_file(AOTCompContext *comp_ctx, char *file_name);
 
diff --git a/core/iwasm/compilation/aot_emit_aot_file.c b/core/iwasm/compilation/aot_emit_aot_file.c
index 1c5906a8..b9c6afd0 100644
--- a/core/iwasm/compilation/aot_emit_aot_file.c
+++ b/core/iwasm/compilation/aot_emit_aot_file.c
@@ -3,7 +3,7 @@
  * SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
  */
 
-#include "aot_compiler.h"
+#include "aot_emit_aot_file.h"
 #include "../aot/aot_runtime.h"
 
 #define PUT_U64_TO_ADDR(addr, value)        \
@@ -25,65 +25,6 @@
         }                                                  \
     } while (0)
 
-/* Internal function in object file */
-typedef struct AOTObjectFunc {
-    char *func_name;
-    /* text offset of aot_func#n */
-    uint64 text_offset;
-    /* text offset of aot_func_internal#n */
-    uint64 text_offset_of_aot_func_internal;
-} AOTObjectFunc;
-
-/* Symbol table list node */
-typedef struct AOTSymbolNode {
-    struct AOTSymbolNode *next;
-    uint32 str_len;
-    char *symbol;
-} AOTSymbolNode;
-
-typedef struct AOTSymbolList {
-    AOTSymbolNode *head;
-    AOTSymbolNode *end;
-    uint32 len;
-} AOTSymbolList;
-
-/* AOT object data */
-typedef struct AOTObjectData {
-    AOTCompContext *comp_ctx;
-
-    LLVMMemoryBufferRef mem_buf;
-    LLVMBinaryRef binary;
-
-    AOTTargetInfo target_info;
-
-    void *text;
-    uint32 text_size;
-
-    void *text_unlikely;
-    uint32 text_unlikely_size;
-
-    void *text_hot;
-    uint32 text_hot_size;
-
-    /* literal data and size */
-    void *literal;
-    uint32 literal_size;
-
-    AOTObjectDataSection *data_sections;
-    uint32 data_sections_count;
-
-    AOTObjectFunc *funcs;
-    uint32 func_count;
-
-    AOTSymbolList symbol_list;
-    AOTRelocationGroup *relocation_groups;
-    uint32 relocation_group_count;
-
-    const char *stack_sizes_section_name;
-    uint32 stack_sizes_offset;
-    uint32 *stack_sizes;
-} AOTObjectData;
-
 #if 0
 static void dump_buf(uint8 *buf, uint32 size, char *title)
 {
diff --git a/core/iwasm/compilation/aot_emit_aot_file.h b/core/iwasm/compilation/aot_emit_aot_file.h
new file mode 100644
index 00000000..7b589ab8
--- /dev/null
+++ b/core/iwasm/compilation/aot_emit_aot_file.h
@@ -0,0 +1,86 @@
+/*
+ * Copyright (C) 2019 Intel Corporation. All rights reserved.
+ * SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
+ */
+
+#ifndef _AOT_EMIT_AOT_FILE_H_
+#define _AOT_EMIT_AOT_FILE_H_
+
+#include "aot_compiler.h"
+
+#ifdef __cplusplus
+extern "C" {
+#endif
+
+/* Internal function in object file */
+typedef struct AOTObjectFunc {
+    char *func_name;
+    /* text offset of aot_func#n */
+    uint64 text_offset;
+    /* text offset of aot_func_internal#n */
+    uint64 text_offset_of_aot_func_internal;
+} AOTObjectFunc;
+
+/* Symbol table list node */
+typedef struct AOTSymbolNode {
+    struct AOTSymbolNode *next;
+    uint32 str_len;
+    char *symbol;
+} AOTSymbolNode;
+
+typedef struct AOTSymbolList {
+    AOTSymbolNode *head;
+    AOTSymbolNode *end;
+    uint32 len;
+} AOTSymbolList;
+
+/* AOT object data */
+typedef struct AOTObjectData {
+    AOTCompContext *comp_ctx;
+
+    LLVMMemoryBufferRef mem_buf;
+    LLVMBinaryRef binary;
+
+    AOTTargetInfo target_info;
+
+    void *text;
+    uint32 text_size;
+
+    void *text_unlikely;
+    uint32 text_unlikely_size;
+
+    void *text_hot;
+    uint32 text_hot_size;
+
+    /* literal data and size */
+    void *literal;
+    uint32 literal_size;
+
+    AOTObjectDataSection *data_sections;
+    uint32 data_sections_count;
+
+    AOTObjectFunc *funcs;
+    uint32 func_count;
+
+    AOTSymbolList symbol_list;
+    AOTRelocationGroup *relocation_groups;
+    uint32 relocation_group_count;
+
+    const char *stack_sizes_section_name;
+    uint32 stack_sizes_offset;
+    uint32 *stack_sizes;
+} AOTObjectData;
+
+bool
+aot_emit_aot_file(AOTCompContext *comp_ctx, AOTCompData *comp_data,
+                  const char *file_name);
+
+uint8 *
+aot_emit_aot_file_buf(AOTCompContext *comp_ctx, AOTCompData *comp_data,
+                      uint32 *p_aot_file_size);
+
+#ifdef __cplusplus
+} /* end of extern "C" */
+#endif
+
+#endif /* end of _AOT_EMIT_AOT_FILE_H_ */
-- 
2.45.1

